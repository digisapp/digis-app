<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <link rel="icon" type="image/png" href="/digis-logo-black.png" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover" />
    <meta name="description" content="Digis - Connect with your favorite creators through video calls, voice calls, and live streaming" />
    <meta name="theme-color" content="#7c3aed" />
    <meta name="mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
    
    <!-- PWA Meta Tags -->
    <link rel="manifest" href="/manifest.json" />
    <link rel="apple-touch-icon" href="/digis-logo-black.png" />
    
    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet" />
    
    <title>Digis - Content Creators</title>
    
    <script>
      // AGGRESSIVE SERVICE WORKER CLEANUP
      // This will run before anything else loads
      (async function() {
        console.log('üßπ Starting aggressive service worker cleanup...');

        // Check if we just did cleanup and reloaded
        const cleanupDone = sessionStorage.getItem('sw-cleanup-done');

        if ('serviceWorker' in navigator) {
          // Get all registrations
          const registrations = await navigator.serviceWorker.getRegistrations();

          // If we have service workers and haven't cleaned up yet
          if (registrations.length > 0 && !cleanupDone) {
            // Unregister everything
            for (let registration of registrations) {
              try {
                const success = await registration.unregister();
                console.log(`üóëÔ∏è Unregistered SW: ${registration.scope} - Success: ${success}`);
              } catch (e) {
                console.error('Failed to unregister:', e);
              }
            }

            // Clear all caches
            if ('caches' in window) {
              const cacheNames = await caches.keys();
              for (let cacheName of cacheNames) {
                try {
                  await caches.delete(cacheName);
                  console.log(`üóëÔ∏è Deleted cache: ${cacheName}`);
                } catch (e) {
                  console.error('Failed to delete cache:', e);
                }
              }
            }

            // Mark cleanup as done and force hard reload
            sessionStorage.setItem('sw-cleanup-done', 'true');
            console.log('‚úÖ Service worker cleanup complete - forcing hard reload...');

            // Hard reload to get fresh assets (bypasses all caches)
            window.location.reload(true);
            return; // Stop execution since we're reloading
          }
        }

        // Clear the flag after successful load
        if (cleanupDone) {
          sessionStorage.removeItem('sw-cleanup-done');
          console.log('‚úÖ Service worker cleanup complete - fresh assets loaded');
        }
      })();
    </script>
    <style>
      /* Base styles */
      body {
        margin: 0;
        padding: 0;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
      }
      #root {
        min-height: 100vh;
      }
      /* Loading screen with logo */
      #root:empty::before {
        content: "";
        display: block;
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        z-index: 9999;
      }
      #root:empty::after {
        content: "";
        display: block;
        position: fixed;
        top: env(safe-area-inset-top, 20px);
        left: 50%;
        transform: translateX(-50%);
        width: 120px;
        height: 120px;
        background-image: url('/digis-logo-white.png');
        background-size: contain;
        background-repeat: no-repeat;
        background-position: center;
        z-index: 10000;
      }
    </style>
  </head>
  <body>
    <noscript>
      <div style="padding: 20px; text-align: center; background: #ff6b6b; color: white;">
        You need to enable JavaScript to run this app.
      </div>
    </noscript>
    <div id="root"></div>
    <div id="modal-root"></div>
    <script type="module" src="/src/main.jsx"></script>

    <script>
      // Global error handler for module loading failures
      window.addEventListener('error', function(event) {
        if (event.message && event.message.includes('Failed to load module script')) {
          console.error('‚ùå Module loading failed - clearing caches and reloading...');

          // Clear all caches and reload ONCE
          if (!sessionStorage.getItem('module-error-reload')) {
            sessionStorage.setItem('module-error-reload', 'true');

            // Clear all caches
            if ('caches' in window) {
              caches.keys().then(function(cacheNames) {
                return Promise.all(
                  cacheNames.map(function(cacheName) {
                    return caches.delete(cacheName);
                  })
                );
              }).then(function() {
                // Hard reload
                window.location.reload(true);
              });
            } else {
              window.location.reload(true);
            }
          } else {
            // If we already tried reloading, show an error
            sessionStorage.removeItem('module-error-reload');
            document.getElementById('root').innerHTML =
              '<div style="padding: 40px; text-align: center; background: #667eea; color: white; font-family: Inter, sans-serif;">' +
              '<h1 style="margin-bottom: 20px;">Loading Error</h1>' +
              '<p style="margin-bottom: 20px;">Unable to load the application. Please try:</p>' +
              '<ol style="text-align: left; display: inline-block; margin-bottom: 20px;">' +
              '<li>Pressing Ctrl+Shift+R (or Cmd+Shift+R on Mac) to hard refresh</li>' +
              '<li>Clearing your browser cache</li>' +
              '<li>Using an incognito/private window</li>' +
              '</ol>' +
              '<button onclick="window.location.reload(true)" style="padding: 12px 24px; background: white; color: #667eea; border: none; border-radius: 8px; font-size: 16px; font-weight: bold; cursor: pointer;">Try Again</button>' +
              '</div>';
          }
        }
      }, true);
    </script>
  </body>
</html>